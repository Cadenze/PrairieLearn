<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: lib/ltiOutcomes.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: lib/ltiOutcomes.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const ERR = require('async-stacktrace');
const request = require('request');
const xml2js = require('xml2js');
const _ = require('lodash');
const path = require('path');
const debug = require('debug')('prairielearn:' + path.basename(__filename, '.js'));

var sqldb = require('@prairielearn/prairielib').sqlDb;
var sqlLoader = require('@prairielearn/prairielib').sqlLoader;
var config = require('./config');
var logger = require('./logger');

var sql = sqlLoader.loadSqlEquiv(__filename);
var parser = new xml2js.Parser({explicitArray: false});
var builder = new xml2js.Builder();

const exampleRequest =
{ imsx_POXEnvelopeRequest:
   { '$':
      { xmlns: 'http://www.imsglobal.org/services/ltiv1p1/xsd/imsoms_v1p0' },
     imsx_POXHeader:
      { imsx_POXRequestHeaderInfo:
         { imsx_version: 'V1.0', imsx_messageIdentifier: '999999123' } },
     imsx_POXBody:
      { replaceResultRequest:
         { resultRecord:
            { sourcedGUID: { sourcedId: '3124567' },
              result: { resultScore: { language: 'en', textString: '0.92' } } } } } } }
;

function xmlReplaceResult(sourcedId, score, identifier) {

    var Obj = _.clone(exampleRequest);

    Obj.imsx_POXEnvelopeRequest.imsx_POXHeader.imsx_POXRequestHeaderInfo.imsx_messageIdentifier = identifier;
    Obj.imsx_POXEnvelopeRequest.imsx_POXBody.replaceResultRequest.resultRecord.sourcedGUID.sourcedId = sourcedId;
    Obj.imsx_POXEnvelopeRequest.imsx_POXBody.replaceResultRequest.resultRecord.result.resultScore.textString = score;

    var xml = builder.buildObject(Obj);
    return xml;
}

/**
 * Check if LTI needs updating for this assessment.
 *
 * @param {number} ai_id - The assessment instance
 * @param {?Object} client - The sqldb client, if we have one, null otherwise.
 * @param {function} callback - A callback(err) function.
 */
var updateScore = function(ai_id, client, callback) {
    if (ai_id == null) return callback(null);

    if (client == null) {
        sqldb.getClient(function(err, client, done) {
            if (ERR(err, callback)) return;
            _updateScoreWithClient(ai_id, client, function(err) {
                // Might not be enough error catching?
                if (ERR(err, callback)) return;
                done(null);
                callback(null);
            });
        });
    } else {
        _updateScoreWithClient(ai_id, client, callback);
    }
};

/**
 * Internal function helper for updateScore, assumes sql-db client.
 */
var _updateScoreWithClient = function(ai_id, client, callback) {

    sqldb.queryWithClientZeroOrOneRow(client, sql.get_score, {ai_id: ai_id}, (err, result) => {
        if (ERR(err, callback)) return;
        if (result.rowCount == 0) {
            return callback(null);
        }

        var info = result.rows[0];

        var score = info.score_perc / 100;
        if (score > 1) { score = 1.0; }
        if (score &lt; 0) { score = 0.0; }

        var post_params = {
            url: info.lis_outcome_service_url,
            oauth: {
                consumer_key: info.consumer_key,
                consumer_secret: info.secret,
                body_hash: true,
            },
            headers: {
                'Content-type': 'application/xml',
            },
            body: xmlReplaceResult(info.lis_result_sourcedid, score, info.date.toString()),
        };

        debug(post_params);
        request.post(post_params, function(err, httpResponse, body) {
            if (ERR(err, callback)) return;

            debug(httpResponse);
            debug(body);
            // Inspect the XML result, log the action
            parser.parseString(body, (err, result) => {
                if (ERR(err, callback)) return;
                const imsx_codeMajor = _.get(result, ['imsx_POXEnvelopeResponse', 'imsx_POXHeader', 'imsx_POXResponseHeaderInfo', 'imsx_statusInfo', 'imsx_codeMajor'], null);
                if (imsx_codeMajor == 'success') {
                    logger.info(`ltiOutcomes.updateScore() ai_id=${ai_id} score=${score} returned ${result.imsx_POXEnvelopeResponse.imsx_POXHeader.imsx_POXResponseHeaderInfo.imsx_statusInfo.imsx_codeMajor}`);
                    debug(`ltiOutcomes.updateScore() ai_id=${ai_id} score=${score} returned ${result.imsx_POXEnvelopeResponse.imsx_POXHeader.imsx_POXResponseHeaderInfo.imsx_statusInfo.imsx_codeMajor}`);
                } else {
                    logger.info(`ltiOutcomes.updateScore() ai_id=${ai_id} score=${score} did not return success, debugging follows:`);
                    logger.info('post_params:', post_params);
                    logger.info('body:', body);
                    debug(`ltiOutcomes.updateScore() ai_id=${ai_id} score=${score} did not return success, debugging follows:`);
                    debug('post_params', post_params);
                    debug('body', body);
                }
                callback(null);
            });
        });
    });
};

// Only run if called directly, for development
// e.g. node lib/ltiOutcomes &lt;assessment_instance_id>
if (require.main == module) {

    var pgConfig = {
        user: config.postgresqlUser,
        database: config.postgresqlDatabase,
        host: config.postgresqlHost,
        password: config.postgresqlPassword,
        max: 100,
        idleTimeoutMillis: 30000,
    };
    var idleErrorHandler = function(err) {
        logger.error('idle client error', err);
    };
    sqldb.init(pgConfig, idleErrorHandler, function(err) {
        if (ERR(err)) return;

        updateScore(parseInt(process.argv[2]), null, (err) => {
            if (ERR(err)) return;
            sqldb.close(function() {});
        });
    });
}

module.exports = {
    updateScore,
};

/*
** Code used to copy the example XML into a JS object. Included here for
** reference but not needed to be run each time.

// https://www.imsglobal.org/specs/ltiomv1p0/specification

const exampleXMLRequest = `
&lt;?xml version="1.0" encoding="UTF-8"?>
&lt;imsx_POXEnvelopeRequest xmlns="http://www.imsglobal.org/services/ltiv1p1/xsd/imsoms_v1p0">
  &lt;imsx_POXHeader>
    &lt;imsx_POXRequestHeaderInfo>
      &lt;imsx_version>V1.0&lt;/imsx_version>
      &lt;imsx_messageIdentifier>999999123&lt;/imsx_messageIdentifier>
    &lt;/imsx_POXRequestHeaderInfo>
  &lt;/imsx_POXHeader>
  &lt;imsx_POXBody>
    &lt;replaceResultRequest>
      &lt;resultRecord>
        &lt;sourcedGUID>
          &lt;sourcedId>3124567&lt;/sourcedId>
        &lt;/sourcedGUID>
        &lt;result>
          &lt;resultScore>
            &lt;language>en&lt;/language>
            &lt;textString>0.92&lt;/textString>
          &lt;/resultScore>
        &lt;/result>
      &lt;/resultRecord>
    &lt;/replaceResultRequest>
  &lt;/imsx_POXBody>
&lt;/imsx_POXEnvelopeRequest>
`;

parser.parseString(exampleXMLRequest, (err, result) => {
    if (ERR(err)) return;
    console.log(util.inspect(result, false, null));
});
*/
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-assessment.html">assessment</a></li><li><a href="module-question.html">question</a></li><li><a href="module-question-servers.html">question-servers</a></li></ul><h3>Classes</h3><ul><li><a href="module-question-NoSubmissionError.html">NoSubmissionError</a></li></ul><h3>Global</h3><ul><li><a href="global.html#_getLock">_getLock</a></li><li><a href="global.html#_updateScoreWithClient">_updateScoreWithClient</a></li><li><a href="global.html#buildDirectory">buildDirectory</a></li><li><a href="global.html#delete">delete</a></li><li><a href="global.html#describe">describe</a></li><li><a href="global.html#ERR">ERR</a></li><li><a href="global.html#extractAndSaveCSRFToken">extractAndSaveCSRFToken</a></li><li><a href="global.html#fetchCheerio">fetchCheerio</a></li><li><a href="global.html#get">get</a></li><li><a href="global.html#getDevHostJobDirectory">getDevHostJobDirectory</a></li><li><a href="global.html#getDevJobDirectory">getDevJobDirectory</a></li><li><a href="global.html#getJobDirectory">getJobDirectory</a></li><li><a href="global.html#getOrUpdateCourseCommitHash">getOrUpdateCourseCommitHash</a></li><li><a href="global.html#makeGradingResult">makeGradingResult</a></li><li><a href="global.html#nonblockingStringify">nonblockingStringify</a></li><li><a href="global.html#RandomGenerator">RandomGenerator</a></li><li><a href="global.html#readInfoJSON">readInfoJSON</a></li><li><a href="global.html#readJSON">readJSON</a></li><li><a href="global.html#readJSONSyncOrDie">readJSONSyncOrDie</a></li><li><a href="global.html#releaseLock">releaseLock</a></li><li><a href="global.html#reset">reset</a></li><li><a href="global.html#Stringifier">Stringifier</a></li><li><a href="global.html#tryLock">tryLock</a></li><li><a href="global.html#updateCourseCommitHash">updateCourseCommitHash</a></li><li><a href="global.html#updateScore">updateScore</a></li><li><a href="global.html#upload">upload</a></li><li><a href="global.html#validateJSON">validateJSON</a></li><li><a href="global.html#validateOptions">validateOptions</a></li><li><a href="global.html#visitMathBlock">visitMathBlock</a></li><li><a href="global.html#waitLock">waitLock</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.4</a> on Tue Jul 21 2020 10:56:01 GMT-0500 (Central Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
