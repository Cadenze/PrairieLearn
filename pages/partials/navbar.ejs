<div class="mb-4">
<nav class="navbar navbar-dark bg-dark navbar-expand-md">
  <a class="navbar-brand" href="<%= homeUrl %>">
    <span class="navbar-brand-label">PrairieLearn</span>
    <span class="navbar-brand-hover-label text-secondary">Go home <i class="fa fa-angle-right" aria-hidden="true"></i></span>
  </a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target=".navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse">
    <ul class="nav navbar-nav mr-auto" id="main-nav">
        <% if (typeof navbarType == 'undefined' || navbarType == 'plain') { %>
        <%- include('navbarPlain'); %>
        <% } else if (navbarType == 'student') { %>
        <%- include('navbarStudent'); %>
        <% } else if (navbarType == 'instructor') { %>
        <%- include('navbarInstructor'); %>
        <% } else { %>
        <% throw new Error('Unknown navbarType: ' + navbarType); %>
        <% } %>
    </ul>

    <!-------------------------------------------------------------------------------->
    <!-------------------------------------------------------------------------------->
    <!-------------------------------------------------------------------------------->
    <!-- User and logout ------------------------------------------------------------->

<%
if (!locals.effective_user_has_no_access_to_course_instance) {
  var displayedName = '';
  if (typeof authz_data !== 'undefined' && authz_data.authn_has_instructor_view) {
      if (authz_data.user.name) {
          displayedName = authz_data.user.name;
      } else {
          displayedName = authz_data.user.uid;
      }
      displayedName += ' (' + authz_data.role;
      if (authz_data.mode != 'Public') {
          displayedName += ', ' + authz_data.mode;
      }
      displayedName += ')';
  } else {
      if (typeof authn_user == 'undefined') {
          displayedName = '(No user)';
      } else if (is_administrator) {
          displayedName = authn_user.name + ' (Administrator)';
      } else {
          displayedName = authn_user.name;
      }
  }
}
%>

<ul class="nav navbar-nav" id="username-nav">

<% if (typeof authz_data !== 'undefined' && authz_data.has_instructor_view) { %>

    <!-- View as different roles -->
    <li class="nav-item mb-2 mb-md-0 mr-2">
        <div class="btn-group" role="group" aria-label="Button group">
        <%
            var roleButtons = {};
            var userIsInstructor = (navbarType == 'instructor');
            var roles = ["instructor", "student"];
            roles.forEach(function(role) {
                roleButtons[role] = {};
                var roleIsInstructor = (role == 'instructor');
                var roleActive = (role == navbarType);
                roleButtons[role].disabled = roleActive;
                roleButtons[role].buttonColor = roleActive ?
                    "btn-primary" :
                    "btn-secondary";
                roleButtons[role].hoverText = roleActive ?
                    `Viewing as ${role}` :
                    `Switch to ${role} view`;
                roleButtons[role].iconClasses = roleIsInstructor ?
                    "fas fa-chalkboard-teacher" :
                    "fas fa-user-graduate";
            });

            if (userIsInstructor) {

                roleButtons['instructor'].link = "";

                // Set student values
                roleButtons['student'].link = `${plainUrlPrefix}/course_instance/${course_instance.id}/assessments`;
                if (typeof assessment !== 'undefined' && assessment.id) {
                    roleButtons['student'].link = `${plainUrlPrefix}/course_instance/${course_instance.id}/assessment/${assessment.id}`;
                }
            } else {

                roleButtons['student'].link = "";

                // Set instructor values
                roleButtons['instructor'].link = `${urlPrefix}/instructor/instance_admin`;
                // If we know its question or assessment id, link right to it.
                if (typeof question !== 'undefined' && question.id) {
                    roleButtons['instructor'].link = `${urlPrefix}/instructor/question/${question.id}`;
                } else if (typeof assessment_instance !== 'undefined' && assessment_instance.assessment_id) {
                    roleButtons['instructor'].link = `${urlPrefix}/instructor/assessment/${assessment_instance.assessment_id}`;
                }
            }

            roles.forEach(function(role) {
        %>
            <a  style="width: 3em;"
                type="button"
                class="btn btn-secondary <% if (roleButtons[role].disabled) { %>disabled<% } %>"
                <% if (!roleButtons[role].disabled) { %>href="<%= roleButtons[role].link %>"<% } %>
                title="<%= roleButtons[role].hoverText %>">
                    <i class="<%= roleButtons[role].iconClasses %>"></i>
            </a>
        <% }); %>
        </div>
    </li>
<% } // has_instructor_view %>


<% if (devMode) { %>
    <li class="mb-2 mb-md-0 mr-2 "><a class="btn btn-success" href="<%= urlPrefix %>/loadFromDisk">Load from disk</a></li>
<% } %>

<% if (!locals.effective_user_has_no_access_to_course_instance) { %>
<li class="nav-item dropdown mb-2 mb-md-0 <% if (navPage == "effective") { %>active<% } %>">
    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        <%= displayedName %>
        <% if (typeof news_item_notification_count != 'undefined' && news_item_notification_count > 0) { %>
          <span class="badge badge-pill badge-primary news-item-count"><%= news_item_notification_count %></span>
        <% } %>
    </a>
    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">

        <!-- News -->
        <a class="dropdown-item news-item-link" href="<%= urlPrefix %>/news_items">
          News
          <% if (typeof news_item_notification_count != 'undefined' && news_item_notification_count > 0) { %>
            <span class="badge badge-pill badge-primary news-item-link-count"><%= news_item_notification_count %></span>
          <% } %>
        </a>

        <!-- Change effective user -->
        <% if (typeof authz_data !== 'undefined' && authz_data.authn_has_instructor_view) { %>
        <a class="dropdown-item" href="<%= urlPrefix %>/effectiveUser">Change effective user</a>
        <% } %>

        <div class="dropdown-divider"></div>

        <!-- Settings -->
        <a class="dropdown-item" href="<%= plainUrlPrefix %>/settings">Settings</a>

        <!-- Log out -->
        <% if (typeof authn_user != 'undefined') { %>
           <% if (authn_provider_name == 'Shibboleth' || authn_provider_name == 'Google' || authn_provider_name == 'Azure'
                  || authn_provider_name == 'LTI') { %>
               <a class="dropdown-item" href="<%= plainUrlPrefix %>/logout">Log out</a>
           <% } else { %>
               <a class="dropdown-item disabled">Log out</a>
           <% } %>
        <% } else { %>
           <a class="dropdown-item disabled">Log out</a>
        <% } %>
    </div>
</li>
<% } %>

</ul>
</div>
</nav>
<% // Mapping navPage to navtab sets
const navPagesTabs = {
    instance_admin: 'navTabs/instructorInstanceAdmin',
    course_admin: 'navTabs/instructorCourseAdmin',
    assessment: 'navTabs/instructorAssessment',
    question: 'navTabs/instructorQuestion'
};
// If navPage matches any of the keys in navPagesTabs, include the page given by its value
if (typeof navPage != 'undefined' && navPagesTabs.hasOwnProperty(navPage)) { %>
    <!-- Instructor navigation tabs -->
    <ul class="nav nav-tabs pl-nav-tabs-bar pt-2 px-3 bg-light">
        <%- include(navPagesTabs[navPage]); %>
    </ul>
<% } %>
</div>
